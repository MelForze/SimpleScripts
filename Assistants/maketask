#!/usr/bin/env bash
#
# create-pentest-project.sh
# Simple pentest project directory generator
#

set -Eeuo pipefail

SCRIPT_NAME="$(basename "$0")"

usage() {
  cat <<EOF
Usage:
  $SCRIPT_NAME <project-name>

Description:
  Interactive script for creating a pentest project directory structure.

Options:
  -h, --help      Show this help message and exit

Example:
  $SCRIPT_NAME ACME-Pentest-2025
EOF
}

ask_yn() {
  local prompt="$1"
  local answer
  while true; do
    read -rp "$prompt (Y/N): " answer
    case "$answer" in
      [Yy]) return 0 ;;
      [Nn]) return 1 ;;
      *) echo "Please enter Y or N." ;;
    esac
  done
}

die() {
  echo "Error: $1" >&2
  exit 1
}

mk_scoped_dirs() {
  # mk_scoped_dirs <prefix-or-empty> <dir1> <dir2> ...
  local prefix="$1"
  shift

  if [[ -n "$prefix" ]]; then
    mkdir -p "$prefix"
    local d
    for d in "$@"; do
      mkdir -p "$prefix/$d"
    done
  else
    mkdir -p "$@"
  fi
}

# ---------- args ----------
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

if [[ $# -ne 1 ]]; then
  usage
  exit 1
fi

PROJECT_NAME="$1"

# safety: avoid dangerous names
if [[ -z "$PROJECT_NAME" || "$PROJECT_NAME" == "." || "$PROJECT_NAME" == ".." || "$PROJECT_NAME" == "/" || "$PROJECT_NAME" == *"/"* ]]; then
  die "Invalid project name: '$PROJECT_NAME' (must be a simple folder name without slashes)"
fi

echo "[*] Creating pentest project: $PROJECT_NAME"

# overwrite prompt
if [[ -e "$PROJECT_NAME" ]]; then
  if ask_yn "Directory '$PROJECT_NAME' already exists. Overwrite it?"; then
    rm -rf -- "$PROJECT_NAME"
  else
    die "Directory '$PROJECT_NAME' already exists"
  fi
fi

mkdir -p "$PROJECT_NAME"
cd "$PROJECT_NAME"

# ---------- base ----------
mkdir -p Report Screenshots

# ---------- scope selection ----------
HAS_EXTERNAL=false
HAS_INTERNAL=false
HAS_AD=false

if ask_yn "Is there External pentesting scope?"; then
  HAS_EXTERNAL=true
fi

if ask_yn "Is there Internal pentesting scope?"; then
  HAS_INTERNAL=true
  if ask_yn "Is this a Windows environment with Active Directory?"; then
    HAS_AD=true
  fi
fi

# Determine whether to create External/Internal wrapper dirs
EXTERNAL_PREFIX=""
INTERNAL_PREFIX=""
if $HAS_EXTERNAL && $HAS_INTERNAL; then
  EXTERNAL_PREFIX="External"
  INTERNAL_PREFIX="Internal"
fi

# ---------- create dirs ----------
if $HAS_EXTERNAL; then
  external_dirs=(bbot_active bbot_passive ffuf httpx katana masscan nessus nmap nuclei subdomains)
  mk_scoped_dirs "$EXTERNAL_PREFIX" "${external_dirs[@]}"
fi

if $HAS_INTERNAL; then
  internal_dirs=(ffuf httpx katana masscan nessus nmap nuclei)
  mk_scoped_dirs "$INTERNAL_PREFIX" "${internal_dirs[@]}"

  if $HAS_AD; then
    ad_dirs=(ad_office ad_pci)
    mk_scoped_dirs "$INTERNAL_PREFIX" "${ad_dirs[@]}"
  fi
fi

# ---------- Mobile ----------
if ask_yn "Is there Mobile pentesting scope?"; then
  mkdir -p Mobile/{Android,iOS}
fi

echo "[+] Project '$PROJECT_NAME' successfully created"